<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Katia Xmas/Bday – Gift List</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root {color-scheme: light dark}
html {font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"}
body {
  background-image: url('https://static.vecteezy.com/system/resources/previews/029/642/930/large_2x/christmas-background-christmas-landscape-background-christmas-wallpaper-landscape-background-ai-generative-free-photo.jpg');
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  min-height: 100vh;
  background-attachment: fixed;
}
.bg-overlay { background-color: rgba(255,255,255,0.45); backdrop-filter: blur(6px); }
.truncate-2 {display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden}
.badge {font-size:.65rem; padding:.2rem .45rem; border-radius:.5rem}
</style>
</head>
<body class="text-slate-900 dark:text-slate-100">
  <div class="bg-overlay max-w-5xl mx-auto p-4 md:p-8 rounded-2xl mt-6 shadow-lg">
    <header class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between mb-6">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold">Katia Xmas/Bday</h1>
        <p class="text-xs mt-1">Amazon list: <a class="underline text-blue-600" href="https://www.amazon.com/hz/wishlist/ls/3DKWBJ9RAO80N?ref_=wl_share" target="_blank" rel="noopener">open wishlist</a></p>
        <div id="syncStatus" class="mt-2 text-[11px] text-slate-500"></div>
      </div>
      <div class="flex gap-2 w-full md:w-auto">
        <input id="search" placeholder="Search items…" class="flex-1 md:w-72 px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 bg-white/70 dark:bg-slate-900 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
        <select id="sort" class="px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 bg-white/70 dark:bg-slate-900 focus:outline-none focus:ring-2 focus:ring-indigo-500">
          <option value="default">Sort: Original</option>
          <option value="price-asc">Price: Low → High</option>
          <option value="price-desc">Price: High → Low</option>
          <option value="name">Name A→Z</option>
          <option value="status">Status</option>
        </select>
      </div>
    </header>

    <section id="items" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></section>

    <footer class="mt-10 text-xs text-slate-700 dark:text-slate-400">
      <p>Tip: Tap “Mark purchased” after you buy an item so others don’t duplicate it. No login needed.</p>
      <p class="mt-1">If you accidentally mark something, tap “Undo”.</p>
    </footer>
  </div>

<script>
const CONFIG = {
  title: "KM Xmas/Bday",
  syncEndpoint: "https://script.google.com/macros/s/AKfycbyHROqS1RdBP7y_BKUnEOCghEBZ-FS0fSfZmq3IbYw9hHj1RufPYwYmLSVsBCbw5lspCg/exec",
  allowUndo: true,
  currency: "USD",
  pollMs: 15000
};

const INITIAL_ITEMS = [
  {id:"tee", cost:19.50, name:"Basic white tee", size:"S", color:"White", link:"https://www.madewell.com/product/whisper-crew-neck-tee", linkLabel:"Whisper Crew Neck Tee | Madewell", purchased:false},
  {id:"mtb-jersey-xl", cost:24.00, name:"MTB Jersey", size:"XL", color:"Orange Pink", link:"https://www.troyleedesigns.com/products/youth-gp-pro-air-jersey-carlsbad-97-orange-pink", linkLabel:"Youth GP Pro Air Jersey Carlsbad 97 Orange / Pink – Troy Lee Designs", purchased:false},
  {id:"moto-jersey-l", cost:44.95, name:"Moto Jersey", size:"L", color:"Grape", link:"https://www.revzilla.com/motorcycle/fox-racing-180-collect-womens-jersey", linkLabel:"Fox Racing 180 Collect Women's Jersey - RevZilla", purchased:false},
  {id:"face-cleanser", cost:46.00, name:"Face Cleanser", size:"400ml", color:"Refill Pack", link:"https://drsambunting.com/products/flawless-cleanser-refill", linkLabel:"Flawless Cleanser Refill | Dr Sam's", purchased:false},
  {id:"screen-protector", cost:56.00, name:"Red light screen protector", size:"Iphone 17 pro max", color:"Red Light Converter + Privacy for iPhone 17 Pro Max", link:"https://www.bodyguardz.com/products/red-light-converter-privacy-iphone-17-pro-max", linkLabel:"Red Light Converter + Privacy for iPhone 17 Pro Max | BodyGuardz", purchased:false},
  {id:"camera-bag", cost:59.65, name:"Camera Bag", size:"", color:"Black", link:"https://www.pgytech.com/products/onego-rope-strap-bag", linkLabel:"OneGo Rope Strap Bag | PGYTECH", purchased:false},
  {id:"charger-3in1", cost:78.99, name:"Charger - Phone, watch, airpods", size:"", color:"Black", link:"https://kuxiu.store/products/x40-turbo-qi2-3-in-1-magsafe-foldable-wireless-charger", linkLabel:"KUXIU X40 Turbo Qi2.2 Certified 25W 3-in-1 MagSafe Foldable Wireless C", purchased:false},
  {id:"camp-slipper", cost:80.00, name:"Camp Slipper", size:"6", color:"Black", link:"https://www.teva.com/women-slippers/re-ember/", linkLabel:"ReEmber Camp Slip On", purchased:false},
  {id:"nike-shoes", cost:90.00, name:"Nike Shoes", size:"6.5 M/8 W", color:"Black/White", link:"https://www.skatewarehouse.com/Nike_SB_Blazer_Low_Pro_GT_Shoes/descpage-NKBLPGT.html?from=bshop&msclkid=996e0faeaa7c1516094a67403a257e65&utm_source=bing&utm_medium=cpc&utm_campaign=Shopping%3A%20Catch%20All%3A%20bshop&utm_term=4583657860375614&utm_content=Catch%20All", linkLabel:"Nike SB Blazer Low Pro GT – Skate Warehouse", purchased:false},
  {id:"levis-wedgie", cost:98.00, name:"Wedgie Straight Ankle Women's Jeans", size:"28W/30L", color:"Black Sprout", link:"https://www.levi.com/US/en_US/apparel/clothing/bottoms/wedgie-straight-womens-jeans/p/228610378", linkLabel:"Wedgie Straight Ankle Women's Jeans - Black | Levi's® US", purchased:false},
  {id:"mtb-jersey-m", cost:100.00, name:"MTB Jersey", size:"M", color:"White", link:"https://dfyrs.com/products/reaper-long-sleeve-flowteq-jersey-silver", linkLabel:"Reaper | Long Sleeve | Flowteq™ Jersey | Silver – DFYRS", purchased:false},
  {id:"mtb-pant", cost:139.00, name:"MTB Pant", size:"M", color:"Twisted Checkers Purple", link:"https://www.evo.com/outlet/pants/troy-lee-designs-lilium-womens", linkLabel:"Troy Lee Designs Lilium Pants - Women's | evo", purchased:false},
  {id:"moto-pant", cost:140.00, name:"Moto Pant", size:"10", color:"Grape", link:"https://www.revzilla.com/motorcycle/fox-racing-180-collect-womens-pants", linkLabel:"Fox Racing 180 Collect Women's Pants - RevZilla", purchased:false}
];

const KEY = "km-gifts-v2";
function loadLocal(){ try{ return JSON.parse(localStorage.getItem(KEY)) || null } catch{ return null } }
function saveLocal(d){ try{ localStorage.setItem(KEY, JSON.stringify(d)) } catch{} }

function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb='__km_cb_'+Math.floor(Math.random()*1e9);
    const s=document.createElement('script');
    window[cb]=data=>{ try{ resolve(data) } finally { delete window[cb]; s.remove(); } };
    s.src=url+(url.includes('?')?'&':'?')+'callback='+cb+'&_t='+(Date.now());
    s.onerror=()=>{ delete window[cb]; s.remove(); reject(new Error('JSONP error')); };
    document.head.appendChild(s);
    setTimeout(()=>{ if(window[cb]){ delete window[cb]; s.remove(); reject(new Error('JSONP timeout')); } }, 10000);
  });
}
async function loadRemote(){
  try{ return await jsonp(CONFIG.syncEndpoint); }catch{ return null }
}
}
async function saveRemote(data){
  try{
    // Use text/plain to avoid CORS preflight; Apps Script reads raw body
    const r = await fetch(CONFIG.syncEndpoint, {
      method:'POST',
      headers:{ 'Content-Type':'text/plain;charset=utf-8' },
      body: JSON.stringify(data)
    });
    return r.ok;
  }catch{ return false }
}

let state = { items: structuredClone(INITIAL_ITEMS) };
let lastPushTs = 0;
let $items,$search,$sort,$syncStatus;

function getFilteredSorted(arr){
  let out=[...arr];
  const q=(($search&&$search.value)||'').trim().toLowerCase();
  if(q) out=out.filter(it=>[it.name,it.size,it.color].some(s=>String(s).toLowerCase().includes(q)));
  const sortVal=(($sort&&$sort.value)||'default');
  switch(sortVal){
    case 'price-asc': out.sort((a,b)=>a.cost-b.cost); break;
    case 'price-desc': out.sort((a,b)=>b.cost-a.cost); break;
    case 'name': out.sort((a,b)=>a.name.localeCompare(b.name)); break;
    case 'status': out.sort((a,b)=>Number(a.purchased)-Number(b.purchased)); break;
    default: out.sort((a,b)=>INITIAL_ITEMS.findIndex(x=>x.id===a.id)-INITIAL_ITEMS.findIndex(x=>x.id===b.id));
  }
  return out;
}

function cardHTML(it){
  return `<article class="rounded-2xl border border-slate-200 dark:border-slate-800 bg-white/70 dark:bg-slate-900/70 p-4 flex flex-col gap-3 shadow-sm">
    <div class="flex items-start justify-between gap-3">
      <h3 class="font-semibold text-base truncate-2">${it.name}</h3>
      <span class="badge ${it.purchased ? 'bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-200' : 'bg-slate-100 text-slate-700 dark:bg-slate-800 dark:text-slate-200'}">${it.purchased ? 'Purchased' : 'Wanted'}</span>
    </div>
    <div class="text-sm grid grid-cols-2 gap-2">
      <div><span class="text-slate-500">Size:</span> ${it.size || '—'}</div>
      <div><span class="text-slate-500">Color:</span> ${it.color || '—'}</div>
      <div class="col-span-2 flex gap-2 items-center">
        <a href="${it.link}" target="_blank" rel="noopener" class="underline text-indigo-600 hover:text-indigo-700 truncate">${it.linkLabel || 'Product link'}</a>
        <button id="copy-${it.id}" class="text-xs px-2 py-1 border rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800">Copy link</button>
      </div>
    </div>
    <div class="mt-1 flex gap-2">
      ${it.purchased ? '' : `<button id="mark-${it.id}" class="flex-1 py-2 rounded-xl bg-indigo-600 text-white font-medium hover:bg-indigo-700">Mark purchased</button>`}
      ${CONFIG.allowUndo && it.purchased ? `<button id="undo-${it.id}" class="flex-1 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800">Undo</button>` : ''}
    </div>
  </article>`
}

function render(){
  const items=getFilteredSorted(state.items);
  $items.innerHTML=items.map(cardHTML).join('');
  for(const it of items){
    document.querySelector(`#mark-${it.id}`)?.addEventListener('click',()=>toggle(it.id,true));
    document.querySelector(`#undo-${it.id}`)?.addEventListener('click',()=>toggle(it.id,false));
    document.querySelector(`#copy-${it.id}`)?.addEventListener('click',()=>copy(it.link));
  }
}

function showSync(text, ok=true){ if(!$syncStatus) return; $syncStatus.textContent=text; $syncStatus.className = ok ? 'text-[11px] text-emerald-600' : 'text-[11px] text-amber-600'; }

function toggle(id,purchased){ const idx=state.items.findIndex(i=>i.id===id); if(idx<0) return; state.items[idx].purchased=purchased; saveLocal(state); render(); lastPushTs=Date.now(); saveRemote(state).then(ok=>{ if(ok) showSync('Changes saved for everyone'); }); }

async function copy(text){ try{ await navigator.clipboard.writeText(text); toast('Link copied'); } catch { toast('Copy failed'); } }
function toast(msg){ const el=document.createElement('div'); el.textContent=msg; el.className='fixed left-1/2 -translate-x-1/2 bottom-6 bg-slate-900 text-white text-sm px-3 py-2 rounded-lg shadow-lg'; document.body.appendChild(el); setTimeout(()=>el.remove(),1400); }

let pollTimer=null;
async function pollRemote(){ if(document.hidden) return; if(Date.now()-lastPushTs < 5000) return; const remote = await loadRemote(); if(remote?.items){ const localJson = JSON.stringify(state.items); const remoteJson = JSON.stringify(remote.items); if(remoteJson !== localJson){ state = remote; saveLocal(state); render(); showSync('Updated just now'); } } }
function startPolling(){ if(!CONFIG.syncEndpoint) return; stopPolling(); pollTimer = setInterval(pollRemote, CONFIG.pollMs); }
function stopPolling(){ if(pollTimer){ clearInterval(pollTimer); pollTimer=null; } }
document.addEventListener('visibilitychange',()=>{ if(document.hidden) stopPolling(); else startPolling(); });

async function setup(){
  $items=document.querySelector('#items');
  $search=document.querySelector('#search');
  $sort=document.querySelector('#sort');
  $syncStatus=document.querySelector('#syncStatus');

  $search.addEventListener('input',render);
  $sort.addEventListener('change',render);

  showSync('Syncing…', true);
  const remote=await loadRemote();
  const local=loadLocal();
  if(remote?.items?.length){ state=remote; showSync('Live sync enabled'); }
  else if(local?.items?.length){ state=local; const ok=await saveRemote(state); showSync(ok?'Uploaded your list for everyone':'Sync offline – saved on this device', ok); }
  else { const ok=await saveRemote(state); showSync(ok?'Live sync enabled':'Sync offline – saved on this device', ok); }
  render();
  startPolling();
}
if(document.readyState==='loading') document.addEventListener('DOMContentLoaded',setup); else setup();
</script>
</body>
</html>
